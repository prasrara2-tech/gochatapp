<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Grup Info - GoChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #d4a373;
            --super-color: #FFD700;
            --off-color: #0084FF;
            --danger: #FF3B30;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: white; -webkit-tap-highlight-color: transparent; }
        .container { width: 100%; max-width: 480px; margin: auto; padding: 20px; box-sizing: border-box; }
        
        /* Profile Header */
        .profile-card { text-align: center; padding: 30px 20px; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%); border-radius: 35px; border: 1px solid var(--border); margin-bottom: 25px; }
        .img-container { position: relative; width: 110px; height: 110px; margin: 0 auto 15px; }
        .group-img { width: 100%; height: 100%; border-radius: 35px; object-fit: cover; border: 2.5px solid var(--accent); }
        .btn-edit-img { position: absolute; bottom: -2px; right: -2px; background: var(--accent); color: #000; width: 32px; height: 32px; border-radius: 10px; display: none; align-items: center; justify-content: center; font-size: 14px; border: 3px solid var(--bg); cursor: pointer; }

        .group-name-box { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .group-name-box h2 { margin: 0; font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
        
        .bio-section { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 20px; text-align: left; cursor: pointer; }
        .bio-label { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; opacity: 0.8; }
        .bio-text { font-size: 13px; color: #ccc; margin: 0; line-height: 1.5; }

        /* Members List */
        .section-title { font-size: 12px; font-weight: 800; color: #666; text-transform: uppercase; margin: 25px 0 15px 5px; letter-spacing: 1px; }
        .member-item { display: flex; align-items: center; padding: 14px; background: var(--card); border-radius: 22px; margin-bottom: 10px; border: 1px solid var(--border); }
        .member-item img { width: 48px; height: 48px; border-radius: 15px; object-fit: cover; margin-right: 15px; }
        .member-info { flex: 1; min-width: 0; }
        .m-name { font-weight: 700; font-size: 15px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .m-id { font-size: 11px; color: #555; font-weight: 600; }

        /* BADGES & ACTION BUTTONS (MENYAMPING) */
        .badge-row { display: flex; align-items: center; gap: 8px; }
        .badge { font-size: 10px; padding: 5px 10px; border-radius: 7px; font-weight: 800; text-transform: uppercase; white-space: nowrap; }
        .bg-super { background: var(--super-color) !important; color: #000 !important; }
        .bg-officer { background: var(--off-color) !important; color: #fff !important; }
        
        .btn-action { padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; border: 1px solid transparent; transition: all 0.2s; }
        .btn-promote { background: rgba(0, 132, 255, 0.1); color: var(--off-color); border-color: rgba(0,132,255,0.3); }
        .btn-demote { background: rgba(255, 59, 48, 0.1); color: var(--danger); border-color: rgba(255,59,48,0.3); }

        /* Admin Controls */
        .admin-panel { background: rgba(212, 163, 115, 0.04); padding: 20px; border-radius: 25px; border: 1px dashed var(--accent); margin-top: 30px; display: none; }
        input { width: 100%; background: #121212; border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; box-sizing: border-box; outline: none; font-family: inherit; }
        .btn-submit { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--accent); color: #000; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 12px; }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 12px 25px; border-radius: 50px; font-weight: 800; display: none; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div class="header" style="margin-bottom:25px;">
        <i class="fas fa-arrow-left" onclick="history.back()" style="cursor:pointer; font-size:18px; color:var(--accent);"></i>
    </div>

    <div class="profile-card">
        <div class="img-container">
            <img id="gPhoto" src="https://cdn-icons-png.flaticon.com/512/615/615075.png" class="group-img">
            <label for="fileInput" id="camIcon" class="btn-edit-img"><i class="fas fa-camera"></i></label>
            <input type="file" id="fileInput" style="display:none" onchange="updateGroupPhoto(this)">
        </div>
        
        <div class="group-name-box">
            <h2 id="gName">Memuat...</h2>
            <i class="fas fa-pencil-alt" id="editNameBtn" style="display:none; color:var(--accent); cursor:pointer; font-size:14px;" onclick="changeGroupName()"></i>
        </div>

        <div class="bio-section" onclick="changeGroupBio()">
            <div class="bio-label">Tentang Grup</div>
            <p id="gBio" class="bio-text">...</p>
        </div>
    </div>

    <div class="section-title">Anggota Grup</div>
    <div id="memberListContainer"></div>

    <div id="adminPanel" class="admin-panel">
        <div class="bio-label" style="margin-bottom:10px;">Tambah Anggota</div>
        <input type="text" id="newUserId" placeholder="Masukkan ID Pengguna...">
        <button class="btn-submit" onclick="inviteUser()">Undang Sekarang</button>
    </div>

    <button onclick="leaveGroup()" style="width:100%; margin-top:30px; padding:18px; border-radius:15px; border:1px solid rgba(255,59,48,0.3); background:transparent; color:var(--danger); font-weight:800; cursor:pointer; font-size:12px; text-transform:uppercase; letter-spacing:1px;">Keluar Grup</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCEamepceiYZtcqlcRnRmFHe0smkGfu_A4",
        authDomain: "gochat-35172.firebaseapp.com",
        databaseURL: "https://gochat-35172-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gochat-35172",
        storageBucket: "gochat-35172.appspot.com",
        appId: "1:206571646434:web:4036d43695a00474499dbb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const myId = localStorage.getItem("gochat_user");
    const gId = new URLSearchParams(window.location.search).get('id');

    let gData = null;
    let myRole = "member";

    function init() {
        if (!gId || !myId) return;

        db.ref(`group_members/${gId}/${myId}`).on("value", rSnap => {
            const role = rSnap.val();
            db.ref(`groups/${gId}`).on("value", snap => {
                gData = snap.val();
                if (!gData) return;
                
                // Cek Role: Super User (Admin), Officer, atau Member
                myRole = (gData.admin === myId) ? "superuser" : (role === "officer" ? "officer" : "member");
                
                document.getElementById("gName").innerText = gData.name;
                document.getElementById("gBio").innerText = gData.bio || "Ketuk untuk menambah deskripsi grup...";
                document.getElementById("gPhoto").src = gData.photo || "https://cdn-icons-png.flaticon.com/512/615/615075.png";
                
                if (myRole !== 'member') {
                    document.getElementById("adminPanel").style.display = "block";
                    document.getElementById("camIcon").style.display = "flex";
                    document.getElementById("editNameBtn").style.display = "block";
                }
                loadMembers();
            });
        });
    }

    function loadMembers() {
        const container = document.getElementById("memberListContainer");
        db.ref(`group_members/${gId}`).on("value", snap => {
            container.innerHTML = "";
            snap.forEach(m => {
                const uid = m.key;
                const role = m.val();
                db.ref(`users/${uid}`).once("value", uSnap => {
                    const u = uSnap.val();
                    const isSU = (uid === gData.admin);
                    const isOff = (role === "officer");
                    
                    const item = document.createElement("div");
                    item.className = "member-item";
                    item.innerHTML = `
                        <img src="${u?.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}">
                        <div class="member-info">
                            <span class="m-name">${u?.username || uid}</span>
                            <span class="m-id">@${uid}</span>
                        </div>
                        <div class="badge-row">
                            ${isSU ? '<span class="badge bg-super">SUPER USER</span>' : ''}
                            ${isOff ? '<span class="badge bg-officer">OFFICER</span>' : ''}
                            ${myRole === 'superuser' && !isSU ? 
                                (!isOff ? `<button class="btn-action btn-promote" onclick="updateRole('${uid}','officer')">Promote</button>` : 
                                         `<button class="btn-action btn-demote" onclick="updateRole('${uid}',true)">Demote</button>`) 
                            : ''}
                        </div>`;
                    container.appendChild(item);
                });
            });
        });
    }

    // ACTIONS
    function changeGroupName() {
        const n = prompt("Ganti Nama Grup:", gData.name);
        if(n && n.trim() !== "") db.ref(`groups/${gId}`).update({ name: n.trim() });
    }

    function changeGroupBio() {
        if(myRole === 'member') return;
        const b = prompt("Ganti Deskripsi:", gData.bio || "");
        if(b !== null) db.ref(`groups/${gId}`).update({ bio: b.trim() });
    }

    function updateGroupPhoto(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => db.ref(`groups/${gId}`).update({ photo: e.target.result });
        reader.readAsDataURL(file);
    }

    function updateRole(uid, val) { 
        if(confirm("Apakah Anda yakin ingin mengubah jabatan anggota ini?")) {
            db.ref(`group_members/${gId}/${uid}`).set(val); 
        }
    }

    function inviteUser() {
        const id = document.getElementById("newUserId").value.trim();
        if(!id) return;
        db.ref(`users/${id}`).once("value", s => {
            if(s.exists()){
                db.ref(`group_members/${gId}/${id}`).set(true);
                showToast("Berhasil ditambahkan!");
                document.getElementById("newUserId").value = "";
            } else showToast("ID tidak ditemukan!");
        });
    }

    function leaveGroup() {
        if(confirm("Keluar dari grup?")) {
            db.ref(`group_members/${gId}/${myId}`).remove();
            window.location.href = "mobile.html";
        }
    }

    function showToast(m) {
        const t = document.getElementById("toast");
        t.innerText = m; t.style.display = "block";
        setTimeout(() => t.style.display="none", 2500);
    }

    init();
</script>
</body>
</html>