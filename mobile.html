<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="image/genre/20.png">

    <title>GoChat Pro - Premium Messaging</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
  
   
    <style>
    :root {
        --bg-base: #0a0a0a;
        --glass-white: rgba(255, 255, 255, 0.03);
        --glass-thick: rgba(15, 15, 15, 0.98);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent: #d4a373; 
        --text-main: #f0f0f0;
        --text-muted: #888;
        --online: #2ecc71;
        --me-chat: linear-gradient(135deg, #d4a373 0%, #b88a5d 100%);
        --you-chat: rgba(255, 255, 255, 0.07);
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { 
        margin: 0; font-family: 'Inter', sans-serif; 
        background: var(--bg-base); color: var(--text-main); 
        height: 100dvh; overflow: hidden; 
    }
    .app { display: flex; height: 100%; width: 100%; position: relative; }

    /* SIDEBAR */
    .sidebar { 
        width: 30%; min-width: 320px; border-right: 1px solid var(--glass-border); 
        display: flex; flex-direction: column; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        z-index: 200; padding-top: var(--safe-top); background: var(--bg-base); 
    }
    .side-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); position: relative; z-index: 10; }
    .my-avatar { width: 45px; height: 45px; border-radius: 14px; object-fit: cover; cursor: pointer; border: 1px solid var(--glass-border); }
    
    .search-container { padding: 15px 20px; }
    .search-box { 
        background: var(--glass-white); border-radius: 15px; padding: 12px; 
        display: flex; align-items: center; gap: 10px; border: 1px solid var(--glass-border); 
    }
    .search-box input { background: transparent; border: none; color: white; width: 100%; font-size: 14px; }
    
    #users { flex: 1; overflow-y: auto; padding: 10px; }
    .user { 
        padding: 14px; border-radius: 18px; display: flex; align-items: center; 
        gap: 14px; cursor: pointer; margin-bottom: 8px; transition: 0.2s; position: relative; 
    }
    .user:hover { background: var(--glass-white); }
    .user img { width: 52px; height: 52px; border-radius: 16px; object-fit: cover; }
    .user-info { flex: 1; min-width: 0; }
    .user-info b { display: block; font-size: 15px; color: #fff; margin-bottom: 2px; }
    .user-info span { font-size: 12px; color: var(--text-muted); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .unread-badge { 
        background: var(--accent); color: #000; min-width: 20px; height: 20px; 
        border-radius: 10px; font-size: 10px; font-weight: bold; 
        display: flex; align-items: center; justify-content: center; padding: 0 6px; 
    }

    /* CHAT AREA */
    .chat { 
        flex: 1; display: flex; flex-direction: column; 
        background: var(--glass-thick); position: relative; 
        padding-top: var(--safe-top); 
    }
    .chat-header { 
        height: 70px; padding: 0 20px; display: flex; align-items: center; 
        gap: 15px; border-bottom: 1px solid var(--glass-border); 
        backdrop-filter: blur(20px); z-index: 10; background: rgba(10,10,10,0.8);
    }

    .msgs { 
        flex: 1; overflow-y: auto; padding: 20px; 
        display: flex; flex-direction: column; gap: 12px; 
        scroll-behavior: smooth; background: radial-gradient(circle at center, #111 0%, #0a0a0a 100%);
    }
    
    .msg-wrap { display: flex; flex-direction: column; max-width: 75%; position: relative; }
    .msg-wrap.me { align-self: flex-end; align-items: flex-end; }
    .msg-wrap.you { align-self: flex-start; align-items: flex-start; }

    .msg { 
        padding: 10px 14px; border-radius: 18px; 
        font-size: 15px; word-wrap: break-word; animation: fadeIn 0.3s ease;
        position: relative;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* --- UPDATE: AGAR PESAN SAYA MIRIP TEMA TEMAN (PUTIH) --- */
.me .msg { 
    /* Kita GUNAKAN style 'you' (Transparent & Teks Putih) */
    background: var(--you-chat); 
    color: white; 
    
    /* Opsional: Hilangkan border radius kiri biar rapi kaya teman */
    border-bottom-left-radius: 18px; 
}
    .msg-meta { display: flex; align-items: center; gap: 4px; font-size: 10px; opacity: 0.7; margin-top: 4px; }
    .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }

    .del-btn { font-size: 10px; color: #ff5e5e; cursor: pointer; opacity: 0; transition: 0.2s; margin-top: 2px; }
    .msg-wrap:hover .del-btn { opacity: 1; }
    .deleted { font-style: italic; opacity: 0.5; }

    audio { height: 35px; filter: invert(1) hue-rotate(180deg); max-width: 210px; margin-top: 5px; }
    .call-msg { 
        text-align: center; font-size: 13px; background: rgba(212, 163, 115, 0.1); 
        padding: 15px; border-radius: 15px; margin: 5px 0; color: var(--accent); 
        border: 1px dashed var(--accent); cursor: pointer;
    }

    /* --- MODIFIKASI DIMULAI DISINI --- */
    
/* --- 1. INPUT AREA (BASE: KHUSUS HP) --- */
.input-area { 
    padding: 10px 2px; /* Padding samping sangat tipis untuk HP */
    background: var(--bg-base); 
    border-top: 1px solid var(--glass-border); 
    /* Padding bawah 30px agar tidak kepotong Home Bar */
    padding-bottom: calc(30px + env(safe-area-inset-bottom)); 
    position: relative;
    min-height: 60px; 
}

/* --- 1. INPUT ROW (BASE: KHUSUS HP) --- */
.input-row { 
    display: flex; 
    align-items: center; 
    gap: 4px; 
    background: var(--glass-white); 
    padding: 10px 2px; /* Padding samping dijadikan 2px supaya benar-benar mepet */
    border-radius: 25px; 
    border: 1px solid var(--glass-border);
    min-height: 45px;
    width: 100%; /* Pastikan lebar 100% */
}

/* --- 2. RECORDING UI --- */
#recording-ui {
    display: none; 
    align-items: center;
    justify-content: space-between;
    width: 100%; 
    flex: 1; /* PENTING: Memaksa elemen ini mengisi sisa ruang kosong */
    background: transparent; 
    padding: 0px 2px; /* Padding vertikal dan horizontal dijadikan 0/2px */
    border-radius: 12px;
    pointer-events: none; 
    position: relative;
    z-index: 10;
    overflow: visible; /* Supaya animasi bisa keluar dikit */
}

/* --- 3. RECORD INFO (Timer Kiri) --- */
.record-info {
    color: #ff5e5e;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px; /* Dikit diperkecil lagi */
    font-weight: 600;
    flex-shrink: 0; /* JANGAN DIKECILKAN otomatis, biarkan timer tetap utuh */
}

/* --- 4. INSTRUKSI SLIDE (KANAN) --- */
#slide-instruction {
    color: #888;
    font-size: 9px; 
    animation: slideLeft 1.5s infinite;
    display: flex;
    align-items: center;
    justify-content: flex-end; /* Rata kanan */
    gap: 2px;
    
    /* --- PENTING: INI YANG MENCEGAH KELEBARAN --- */
    max-width: 45%; /* Batasi lebar maksimal hanya 45% layar HP */
    white-space: nowrap; /* Jangan turun ke baris bawah */
    overflow: hidden; /* Sembunyikan teks yang kepanjangan */
    text-overflow: ellipsis; /* Tampilkan titik-titik (...) jika kepanjangan */
}

/* =========================================
   KHUSUS LAPTOP (AGAR KEMBALI BAGUS)
   ========================================= */
@media (min-width: 769px) {
    .input-row {
        gap: 10px; 
        padding: 10px 15px;
    }

    #slide-instruction {
        font-size: 13px;
        max-width: 60%; /* Di laptop boleh lebih lebar */
        white-space: nowrap; /* Tetap satu baris */
    }
}
    
    #text { 
        flex: 1; 
        border: none; 
        background: transparent; 
        color: white; 
        padding: 8px 2px; /* Padding atas bawah disesuaikan agar rapi */
        font-size: 16px; /* Tetap 16px agar tidak zoom */
    }
    
    .btn-action { 
        background: none; 
        border: none; 
        color: var(--text-muted); 
        font-size: 20px; 
        cursor: pointer; 
        /* Tambahkan sedikit margin agar tidak menempel tepi */
        margin: 0 2px;
    }

    #emojiPanel {
        display: none; position: absolute; bottom: 85px; left: 15px; right: 15px;
        background: #161616; border: 1px solid var(--glass-border); border-radius: 20px;
        padding: 15px; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px;
        max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 -10px 25px rgba(0,0,0,0.5);
    }
    .emoji-item { font-size: 24px; text-align: center; cursor: pointer; padding: 5px; border-radius: 10px; transition: 0.2s; }
    .emoji-item:hover { background: var(--glass-white); }
    
    .recording-active { animation: pulse-red 1s infinite; color: #ff5e5e !important; }
    @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

    .btn-send { 
        background: var(--accent); border: none; width: 38px; height: 38px; /* Dikit diperkecil */
        border-radius: 50%; color: black; cursor: pointer; 
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; /* Mencegah tombol mengecil */
    }

    #toast { 
        position: fixed; top: 40px; left: 50%; transform: translateX(-50%); 
        background: var(--accent); color: black; padding: 10px 20px; 
        border-radius: 20px; z-index: 9999; display: none; font-weight: bold; 
    }

   .modal {
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.9); 
        z-index: 3000; 
        align-items: center; 
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .modal-content { 
        background: #161616; padding: 30px; border-radius: 25px; 
        width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--glass-border);
    }

    @media (max-width: 768px) {
        .sidebar { width: 100%; position: absolute; height: 100%; left: 0; top: 0; }
        .sidebar.hidden { transform: translateX(-100%); }
        .chat { width: 100%; }
    }

    /* Style untuk Menu Pilihan */
    .msg-context-menu {
        display: none; position: fixed; z-index: 2000;
        background: #1a1a1a; border: 1px solid var(--glass-border);
        border-radius: 15px; width: 170px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .menu-item {
        padding: 12px 15px; font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer;
    }
    .menu-item:hover { background: var(--glass-white); color: var(--accent); }
    .menu-item.danger { color: #ff5e5e; }

    #reply-preview {
        display: none; 
        padding: 10px 12px; /* Padding dikit diperkecil */
        background: #1a1a1a; 
        border-left: 4px solid var(--accent); 
        border-top: 1px solid var(--glass-border);
        margin: 0; 
        position: absolute;
        bottom: 100%; 
        left: 0;
        right: 0;
        z-index: 5;
        animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .forward-tag { font-size: 10px; opacity: 0.6; font-style: italic; margin-bottom: 3px; }
    
    /* Action Sheet Hapus */
    .action-sheet-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
        z-index: 3000; align-items: flex-end;
    }
    .action-sheet {
        width: 100%; background: #1a1a1a; border-top-left-radius: 20px; border-top-right-radius: 20px;
        padding: 20px; animation: slideUp 0.3s ease-out;
    }
    .sheet-header { color: #888; text-align: center; margin-bottom: 15px; font-size: 14px; }
    .sheet-btn {
        width: 100%; padding: 15px; border: none; border-radius: 12px; margin-bottom: 10px;
        font-size: 16px; font-weight: bold; cursor: pointer;
    }
    .sheet-btn.danger { background: #ff4757; color: white; }
    .sheet-btn.cancel { background: #333; color: white; }

    .user.pinned {
        background: rgba(212, 163, 115, 0.12) !important;
        border-left: 4px solid var(--accent) !important;
    }

    .pin-icon {
        color: var(--accent);
        font-size: 11px;
        margin-left: 6px;
        transform: rotate(45deg);
        display: inline-block;
    } 

    .context-menu {
        position: fixed !important;
        display: none;
        background: #1a1a1a !important; 
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 12px !important;
        width: 180px !important;
        z-index: 9999999 !important; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.9) !important;
        overflow: hidden !important;
        padding: 5px 0 !important;
    }

    .context-menu-item {
        padding: 12px 16px !important;
        font-size: 14px !important;
        color: #ffffff !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        cursor: pointer !important;
        background: transparent !important;
        transition: 0.2s;
    }

    .context-menu-item:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .context-menu-item i {
        width: 20px !important;
        text-align: center !important;
        color: #d4af37 !important; 
    }

    .context-menu-item.danger {
        color: #ff5e5e !important;
    }

    .context-menu-item.danger i {
        color: #ff5e5e !important;
    }

    #recording-ui[style*="display: flex"] {
        pointer-events: auto;
    }

    .blink {
        animation: blink-red 1s infinite;
    }

    @keyframes blink-red {
        0% { opacity: 1; }
        50% { opacity: 0.2; }
        100% { opacity: 1; }
    }


    @keyframes slideLeft {
        0% { 
            transform: translateX(0); 
            opacity: 1; 
        }
        100% { 
            transform: translateX(-15px); 
            opacity: 0.2; 
        }
    }

    #normal-input {
        transition: all 0.2s ease;
    }
    .btn-action, #micButton {
        cursor: pointer; 
        user-select: none; 
    }
    
    .vn-player {
        max-width: 200px;
        height: 35px;
        border-radius: 20px;
        filter: sepia(20%) saturate(70%) grayscale(1);
    }
    
    .fa-users, .fa-user-plus {
        position: relative;
        z-index: 10;
    }

    /* =========================================
    MODAL VIDEO CALL (JITSI ONLY - GANTIKAN AGORA)
    ========================================= */

/* 1. Modal Utama */
#videoCallModal {
    display: none; /* Hidden by default */
    position: fixed;
    inset: 0; /* Sama seperti top:0; right:0; bottom:0; left:0; */
    background: #000;
    z-index: 10000000; /* Paling Atas (Agar menutupi semua) */
    width: 100%;
    height: 100%;
    padding-top: env(safe-area-inset-top); /* Safe Area iPhone */
    padding-bottom: env(safe-area-inset-bottom);
}

/* 2. Container Jitsi */
#jitsi-container {
    width: 100%;
    height: 100%;
    display: none; /* Hidden saat tidak dipakai */
}


</style>
</head>
<body>

<div id="toast"></div>

<audio id="notificationSound" src="note.mp3" preload="auto"></audio>

<audio id="ringtoneSound" src="night-owl.mp3" preload="auto" loop></audio>

<div class="app">
    <div class="sidebar" id="sidebar">
        <div class="side-header">
            <div style="display:flex; align-items:center;" onclick="window.location.href='profile.html'">
                <img id="myPhotos" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="my-avatar">
                <div id="myName" style="margin-left:12px; font-weight:600; font-size:18px;">...</div>
            </div>
            <div style="display:flex; gap:18px;">
                <i class="fa fa-users" onclick="openCreateGroup()" style="color:var(--accent); font-size:18px; cursor:pointer;"></i>
                <i class="fa fa-user-plus" onclick="openAddFriend()" style="color:var(--accent); font-size:18px; cursor:pointer;"></i>
                <i class="fa fa-sign-out-alt" onclick="logout()" style="color:#ff5e5e; font-size:18px; cursor:pointer;"></i>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <i class="fa fa-search" style="color:var(--accent)"></i>
                <input type="text" id="userSearch" placeholder="Cari percakapan..." oninput="searchUser()">
            </div>
        </div>

        <div id="users"></div>
    </div>

    <div class="chat">
        <div id="welcome-screen" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:40px;">
            <div style="width:100px; height:100px; background:var(--glass-white); border-radius:30px; display:flex; align-items:center; justify-content:center; margin-bottom:20px; border:1px solid var(--glass-border);">
                <i class="fa fa-shield-halved" style="font-size:45px; color:var(--accent)"></i>
            </div>
            <h2 style="letter-spacing:2px; margin-bottom:5px;">GOCHAT <span style="color:var(--accent)">PRO</span></h2>
            <p style="color:var(--text-muted); font-size:14px; max-width:250px;">Enkripsi End-to-End AES-256 Aktif.</p>
        </div>

        <div id="chat-header-area" class="chat-header" style="display:none;">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size:18px; cursor:pointer;"></i>
            <img id="chatAvatar" src="" onclick="goToProfile()" style="width:42px; height:42px; border-radius:12px; margin-left:5px; object-fit:cover;">
            <div id="chat-info-block" style="flex:1; margin-left:5px; min-width:0;" onclick="goToProfile()">
                <b id="chatName" style="display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">...</b>
                <div id="chatStatus" style="font-size:11px;">...</div>
            </div>
            <div style="display:flex; gap:22px; color:var(--accent); font-size:18px;">
                <i class="fas fa-phone" onclick="startJitsi('audio')" style="cursor:pointer;"></i>
                <i class="fas fa-video" onclick="startJitsi('video')" style="cursor:pointer;"></i>
            </div>
        </div>

        <div id="msgs" class="msgs" style="display:none;"></div>

        <div id="inputArea" class="input-area" style="display:none;">
            <div id="reply-preview" onclick="if(replyData) scrollToMessage(replyData.id)" style="cursor:pointer;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <b id="reply-user" style="color:var(--accent); font-size:12px;">Nama</b>
                    <i class="fa fa-times" onclick="event.stopPropagation(); cancelReply()" style="cursor:pointer; color:#888; padding:5px;"></i>
                </div>
                <div id="reply-text" style="font-size:11px; color:#bbb; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Pesan</div>
            </div>

            <div id="emojiPanel"></div>

           <div class="input-row">
            <div id="normal-input" style="display:flex; flex:1; align-items:center; gap:10px;">
                <button id="emojiButton" class="btn-action"><i class="far fa-smile"></i></button>
                <!-- Tombol Gambar -->
<label for="imgInput" class="btn-action">
    <i class="far fa-image"></i>
</label>
<!-- Input File Tersembunyi -->
<input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(this)">
                <input type="text" id="text" placeholder="Ketik pesan..." autocomplete="off">
            </div>

           <div id="recording-ui">
            <div class="record-info">
                <i class="fas fa-microphone blink"></i>
                <span id="record-timer">00:00</span>
            </div>
            <div id="slide-instruction">
                <i class="fas fa-chevron-left"></i> Geser ke kiri untuk batal
            </div>
        </div>

            <div style="display:flex; align-items:center; gap:5px;">
                <button id="micButton" class="btn-action"><i class="fas fa-microphone"></i></button>
                <button id="sendButton" class="btn-send" onclick="send()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- MODALS DIPINDAHKAN KE SINI (LUAR APP) -->

<div id="addFriendModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0;">Tambah Teman</h3>
        <input type="text" id="friendInput" placeholder="ID User (Contoh: Budi_1234)" style="width:100%; padding:14px; border-radius:12px; background:#000; border:1px solid #333; color:white; margin:15px 0; text-align:center;">
        <button onclick="processAddFriend()" style="width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; font-weight:bold; color:black;">TAMBAH KONTAK</button>
        <p onclick="closeAddFriend()" style="margin-top:20px; color:#666; cursor:pointer; font-size:14px;">Batal</p>
    </div>
</div>

<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0;">Buat Grup Baru</h3>
        <input type="text" id="groupNameInput" placeholder="Nama Grup" style="width:100%; padding:14px; border-radius:12px; background:#000; border:1px solid #333; color:white; margin:15px 0; text-align:center;">
        <button onclick="processCreateGroup()" style="width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; font-weight:bold; color:black;">BUAT GRUP SEKARANG</button>
        <p onclick="closeCreateGroup()" style="margin-top:20px; color:#666; cursor:pointer; font-size:14px;">Batal</p>
    </div>
</div>

<div id="msgMenu" class="msg-context-menu">
    <div class="menu-item" onclick="handleReply()"><i class="fa fa-reply"></i> Balas</div>
    <div class="menu-item" onclick="handleCopy()"><i class="fa fa-copy"></i> Salin</div>
    <div class="menu-item" id="menu-edit" onclick="handleEdit()"><i class="fa fa-edit"></i> Edit</div>
    <div class="menu-item" onclick="handleForward()"><i class="fa fa-share"></i> Teruskan</div>
    <hr style="border:0; border-top:1px solid #333; margin:0;">
    <div class="menu-item danger" onclick="handleDelete()"><i class="fa fa-trash"></i> Hapus</div>
</div>

<div id="deleteSheet" class="action-sheet-overlay" onclick="closeDeleteSheet()">
    <div class="action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-header">Hapus pesan?</div>
        <button id="btnDeleteEveryone" class="sheet-btn danger" onclick="confirmDeleteEveryone()">Hapus untuk Semua Orang</button>
        <button class="sheet-btn danger" onclick="confirmDeleteMe()">Hapus untuk Saya</button>
        <button class="sheet-btn cancel" onclick="closeDeleteSheet()">Batal</button>
    </div>
</div>

<!-- MODAL VIDEO CALL (PURE JITSI ONLY) -->
<div id="videoCallModal" style="display: none; position: fixed; inset: 0; background: #000; z-index: 10000000; width: 100%; height: 100%;">
    
    <!-- Tombol Tutup -->
    <div style="position: absolute; top: 20px; right: 20px; z-index: 10;">
        <button onclick="endVideoCall()" style="background: #ff5e5e; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold;">
            <i class="fas fa-phone-slash"></i> Tutup
        </button>
    </div>

    <!-- HANYA CONTAINER JITSI -->
    <div id="jitsi-container" style="width: 100%; height: 100%; display: none;"></div>
</div>
<script>
/* =========================================
    CONFIG & INIT
    ========================================= */
const firebaseConfig = {
    apiKey: "AIzaSyCEamepceiYZtcqlcRnRmFHe0smkGfu_A4",
    authDomain: "gochat-35172.firebaseapp.com",
    databaseURL: "https://gochat-35172-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gochat-35172",
    storageBucket: "gochat-35172.appspot.com",
    appId: "1:206571646434:web:4036d43695a00474499dbb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const currentUser = localStorage.getItem("gochat_user");
const SECRET_KEY = "Global_Key_123";
const contextMenu = document.getElementById('contextMenu');
const menuOverlay = document.getElementById('menuOverlay');
const micBtn = document.getElementById("micButton");
const sendBtn = document.getElementById("sendButton");
const recordingUI = document.getElementById("recording-ui");
const textInput = document.getElementById("text");
const normalInput = document.querySelector(".input-area");

let currentChatId = null;
let activeChatRef = null; 
let currentPartnerId = null;
let isGroup = false;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let vnBlob = null;
let typingTimeout;
let selectedMsgId = null;
let selectedMsgData = null;
let isEditing = false;
let replyData = null;
let groupMembersCount = {};
let holdTimer;
let currentMsgRef = null;
let startX;
let isCancelled = false;
let recordInterval;
let localStream = null;
let jitsiApi = null;
let globalNotifListener = null; // <--- WAJIB DI SINI!
let chatListeners = {};
let lastProcessedMsgKey = null;
let isWindowFocused = document.hasFocus();
let isNotificationSetupDone = false;
let contactsListener = null; // <--- TAMBAHKAN INI! AGAR ERROR HILANG
let unreadListeners = {}; 
let audioContextUnlocked = false;
    
// Cek Fokus
window.addEventListener('focus', () => {
    isWindowFocused = true;
});

// Cek Blur (Saat klik tab lain / minimize)
window.addEventListener('blur', () => {
    isWindowFocused = false;
});

function initApp() {
    if(!currentUser) { window.location.href="index.html"; return; }
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker terdaftar!', reg))
            .catch(err => console.error('Gagal registrasi SW:', err));
    }

    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    // --- 1. SETUP NOTIFIKASI (PENTING!) ---
    setupGlobalNotificationListener();
    
    // --- 2. SETUP USER ---
    db.ref("users/" + currentUser).on("value", s => {
        const d = s.val();
        if(d) {
            document.getElementById("myName").innerText = d.username;
            document.getElementById("myPhotos").src = d.photo || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            db.ref("users/" + currentUser).update({ online: true, lastSeen: Date.now() });
        }
    });

    db.ref("users/" + currentUser + "/online").onDisconnect().set(false);
    db.ref("users/" + currentUser + "/lastSeen").onDisconnect().set(Date.now());

    // --- 3. LOAD CONTACTS & LAINNYA ---
    loadContacts();
    setupEmoji();
    setupTypingListener();
}

/* =========================================
    FUNGSI GROUP (SUDAH DIPERBAIKI - TIDAK GANDA)
    ========================================= */
function openCreateGroup() { 
    document.getElementById("createGroupModal").style.display = "flex"; 
    document.getElementById("groupNameInput").value = "";
}

function closeCreateGroup() { 
    document.getElementById("createGroupModal").style.display = "none"; 
}

function processCreateGroup() {
    const name = document.getElementById("groupNameInput").value.trim();
    
    if(!name) {
        showToast("Nama grup tidak boleh kosong!");
        return;
    }

    const groupId = "GROUP_" + Date.now();
    const groupData = {
        id: groupId,
        name: name,
        admin: currentUser,
        photo: "https://cdn-icons-png.flaticon.com/512/615/615075.png",
        createdAt: Date.now()
    };

    db.ref("groups/" + groupId).set(groupData);
    db.ref(`group_members/${groupId}/${currentUser}`).set(true);
    
    db.ref(`user_chats/${currentUser}/${groupId}`).set({
        lastMsg: "Grup baru dibuat",
        time: Date.now()
    }).then(() => {
        showToast("Grup '" + name + "' berhasil dibuat!");
        closeCreateGroup();
    });
}

/* =========================================
    FUNGSI ADD FRIEND (SUDAH DIPERBAIKI - TIDAK GANDA)
    ========================================= */
function openAddFriend() { 
    document.getElementById("addFriendModal").style.display = "flex"; 
    document.getElementById("friendInput").value = "";
}

function closeAddFriend() { 
    document.getElementById("addFriendModal").style.display = "none"; 
}

function processAddFriend() {
    const id = document.getElementById("friendInput").value.trim();
    
    if(!id) {
        showToast("ID Teman tidak boleh kosong!");
        return;
    }

    if(id === currentUser) {
        showToast("Tidak bisa menambahkan diri sendiri!");
        return;
    }

    db.ref("users/" + id).once("value", s => {
        if(s.exists()) {
            
            // 1. TAMBAHKAN KE DAFTAR CHAT SAYA (Agar muncul di sidebar saya)
            db.ref(`user_chats/${currentUser}/${id}`).update({ 
                lastMsg: "Kontak baru", 
                time: Date.now() 
            });

            // 2. TAMBAHKAN KE DAFTAR CHAT TEMAN (Agar muncul di sidebar dia) <-- INI YANG HILANG
            db.ref(`user_chats/${id}/${currentUser}`).update({ 
                lastMsg: "Permintaan pertemanan baru", 
                time: Date.now() 
            }).then(() => {
                showToast("Berhasil menambahkan teman!");
                closeAddFriend();
            });

        } else {
            alert("ID User '" + id + "' tidak ditemukan!");
        }
    });
}
/* =========================================
    TYPING STATUS LOGIC
    ========================================= */
function setupTypingListener() {
    const input = document.getElementById("text");
    input.addEventListener("input", () => {
        if(!currentChatId) return;
        
        const myDisplayName = document.getElementById("myName").innerText;
        
        db.ref(`typing/${currentChatId}/${currentUser}`).set(myDisplayName);
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            db.ref(`typing/${currentChatId}/${currentUser}`).remove();
        }, 2000);
    });
}

function watchTyping(chatId) {
    db.ref(`typing/${chatId}`).on("value", snap => {
        const typers = snap.val();
        const statusEl = document.getElementById("chatStatus");
        
        if(!typers) {
            if(isGroup) { 
                statusEl.innerText = "Grup Chat"; 
                statusEl.style.color = "var(--text-muted)"; 
            } else { 
                updatePartnerOnlineStatus(); 
            }
            return;
        }

        let otherTypers = Object.keys(typers).filter(uid => uid !== currentUser);

        if(otherTypers.length > 0) {
            statusEl.style.color = "var(--accent)";
            
            if(isGroup) {
                let names = otherTypers.map(uid => typers[uid]);
                statusEl.innerText = `${names.join(", ")} sedang mengetik...`;
            } else {
                statusEl.innerText = "sedang mengetik...";
            }
        } else {
            if(isGroup) {
                statusEl.innerText = "Grup Chat";
                statusEl.style.color = "var(--text-muted)";
            } else {
                updatePartnerOnlineStatus();
            }
        }
    });
}

function updatePartnerOnlineStatus() {
    db.ref("users/" + currentPartnerId).once("value", s => {
        const u = s.val();
        const st = document.getElementById("chatStatus");
        st.innerText = u?.online ? "online" : "offline";
        st.style.color = u?.online ? "var(--online)" : "var(--text-muted)";
    });
}
function unlockAudioContext() {
    if (audioContextUnlocked) return;
    const audio = document.getElementById('notificationSound');
    if (audio) {
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            audioContextUnlocked = true;
            console.log(">>> AUDIO SUDAH DIAKTIFKAN");
        }).catch(e => {});
    }
}

// Aktifkan saat user klik/touch layar
document.addEventListener('click', unlockAudioContext, { once: true });
document.addEventListener('touchstart', unlockAudioContext, { once: true });
/* =========================================
    CONTACTS & LIST
    ========================================= */
function loadContacts() {
    // 1. Matikan listener lama saat fungsi di-load ulang
    if (contactsListener) {
        db.ref(`user_chats/${currentUser}`).off('value', contactsListener);
    }

    contactsListener = db.ref(`user_chats/${currentUser}`).on("value", async (snap) => {
        
        // Ambil data Pinned sekali saja untuk referensi
        const pinnedSnap = await db.ref(`user_settings/${currentUser}/pinned_chats`).once("value");
        const pinnedIds = pinnedSnap.val() || {};
        const list = document.getElementById("users");
        
        // Array untuk menyimpan ID chat yang ada di snapshot saat ini
        let currentSnapshotIds = [];
        
        // Loop data chat dari Firebase
        snap.forEach(c => { 
            const id = c.key;
            currentSnapshotIds.push(id);
            
            const info = c.val();
            if(!info) return;

            // Cek apakah elemen HTML sudah ada di layar
            const el = document.getElementById(`contact-${id}`);
            
            // Persiapan data User/Group
            const isGrp = id.startsWith("GROUP_");
            const refPath = isGrp ? "groups/" + id : "users/" + id;
            
            // Ambil data User/Grup (Agar nama/foto terupdate)
            db.ref(refPath).once("value", uSnap => {
                const u = uSnap.val();
                const isPinned = !!pinnedIds[id];
                const chatId = isGrp ? id : [currentUser, id].sort().join("_");

                if (el) {
                    // --- SCENARIO A: UPDATE (Chat sudah ada di layar) ---
                    
                    // Update Class jika status pinned berubah
                    if (isPinned && !el.classList.contains('pinned')) el.classList.add('pinned');
                    if (!isPinned && el.classList.contains('pinned')) el.classList.remove('pinned');

                    // Update Text
                    const nameEl = el.querySelector("b");
                    const msgEl = el.querySelector("span");
                    
                    if(nameEl) nameEl.innerText = `${u?.name || u?.username || id} ${isPinned ? 'ðŸ“Œ' : ''}`;
                    if(msgEl) msgEl.innerText = info.lastMsg || '...';

                } else {
                    // --- SCENARIO B: CREATE (Chat baru belum ada di layar) ---
                    
                    let div = document.createElement("div");
                    div.id = `contact-${id}`; 
                    div.className = `user ${isPinned ? 'pinned' : ''}`;
                    
                    div.innerHTML = `
                        <img src="${u?.photo || (isGrp ? 'https://cdn-icons-png.flaticon.com/512/615/615075.png' : 'https://cdn-icons-png.flaticon.com/512/149/149071.png')}" 
                             onclick="event.stopPropagation(); goToTargetProfile('${id}', ${isGrp})"
                             style="width:52px; height:52px; border-radius:16px; object-fit:cover;">
                        <div class="user-info" onclick="openChat('${id}', '${u?.photo || ''}', '${u?.name || u?.username || id}', ${isGrp})">
                            <b>${u?.name || u?.username || id} ${isPinned ? 'ðŸ“Œ' : ''}</b>
                            <span>${info.lastMsg || '...'}</span>
                        </div>
                    `;

                    setupHoldListener(div, id);
                    list.appendChild(div);

                    // --- PENTING: BUAT LISTENER BARU HANYA UNTUK CHAT BARU INI ---
                    if (!chatListeners[id]) chatListeners[id] = { badge: null, notif: null };

                    // 1. Listener Badge (Unread Count)
                    if (!chatListeners[id].badge) {
                        const unreadRef = db.ref("chats/" + chatId).limitToLast(30).orderByChild("seen").equalTo(false);
                        
                        const badgeHandler = (unreadSnap) => {
                            let count = 0;
                            unreadSnap.forEach(m => { 
                                if(m.val().from !== currentUser) count++; 
                            });
                            
                            const currentEl = document.getElementById(`contact-${id}`);
                            if(currentEl) {
                                let badgeEl = currentEl.querySelector('.unread-badge');
                                if(count > 0) {
                                    if(!badgeEl) {
                                        badgeEl = document.createElement("div");
                                        badgeEl.className = "unread-badge";
                                        currentEl.appendChild(badgeEl);
                                    }
                                    badgeEl.innerText = count;
                                } else {
                                    if(badgeEl) badgeEl.remove();
                                }
                            }
                        };
                        
                        unreadRef.on("value", badgeHandler);
                        chatListeners[id].badge = unreadRef; 
                    }

                                      // 2. Listener Notifikasi (Sound & Popup)
                    if (!chatListeners[id].notif) {
                        const notifRef = db.ref("chats/" + chatId).limitToLast(1);
                        
                        const notifHandler = (msgSnap) => {
                            msgSnap.forEach(s => {
                                const m = s.val();
                                
                                // DEBUG
                                console.log(`[DEBUG] Pesan Masuk: From=${m.from} | MyID=${currentUser} | CurrentChat=${currentChatId}`);

                                if (m.from !== currentUser && currentChatId !== chatId && !m.deleted) {
                                    
                                    // --- LOGIKA BARU: CEK TIPE PESAN DULU SEBELUM MAINKAN SUARA ---
                                    
                                    let notifBody = "";
                                    let soundType = 'message'; // Default: Suara Pesan biasa

                                    if (m.text.startsWith("CALL_JITSI:")) {
                                        // JIKA PANGGILAN: Gunakan Ringtone
                                        soundType = 'ringtone'; 
                                        notifBody = "ðŸ“ž Panggilan Masuk...";
                                    } 
                                    else if (m.text.startsWith("IMG:")) {
                                        notifBody = "ðŸ“· Mengirim Gambar...";
                                    } 
                                    else if (m.text.startsWith("TYPE:VN:")) {
                                        notifBody = "ðŸŽ¤ Mengirim Voice Note...";
                                    } 
                                    else {
                                        try { notifBody = decryptData(m.text); } catch(e) { notifBody = "Pesan baru"; }
                                    }

                                    // --- MAINKAN SUARA BERDASARKAN TIPE ---
                                    // Jika soundType = 'ringtone', dia akan memainkan file night-owl.mp3
                                    playNotificationSound(soundType);

                                    // --- TAMPILKAN POP-UP ---
                                    const isUserTyping = (document.activeElement.id === 'text');
                                    
                                    if (!isUserTyping) {
                                        const senderName = isGrp ? (u?.name || "Grup") : (u?.username || "Teman");
                                        showSystemNotification(senderName, notifBody, id);
                                    }
                                }
                            });
                        };
                        
                        notifRef.on("child_added", notifHandler);
                        chatListeners[id].notif = notifRef;
                    }
                }
            });
        });

        // --- SCENARIO C: REMOVE (Chat dihapus dari database) ---
        const existingDivs = document.querySelectorAll('.user');
        existingDivs.forEach(div => {
            const divId = div.id.replace('contact-', '');
            if (!currentSnapshotIds.includes(divId)) {
                if (chatListeners[divId]) {
                    if (chatListeners[divId].badge) chatListeners[divId].badge.off();
                    if (chatListeners[divId].notif) chatListeners[divId].notif.off();
                    delete chatListeners[divId];
                }
                div.remove();
            }
        });

        // --- SORTING ---
        let items = [];
        snap.forEach(c => { 
            items.push({ id: c.key, info: c.val(), isPinned: !!pinnedIds[c.key] });
        });
        items.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;
            return b.info.time - a.info.time;
        });

        items.forEach(item => {
            const el = document.getElementById(`contact-${item.id}`);
            if(el) {
                list.appendChild(el);
            }
        });
    });
}
/* =========================================
    MESSAGING CORE
    ========================================= */
function openChat(pId, photo, name, grp = false) {
    if (activeChatRef) {
        activeChatRef.off();
        console.log("Koneksi chat lama diputus.");
    }
     const ringtone = document.getElementById('ringtoneSound');
    if(ringtone) {
        ringtone.pause();
        ringtone.currentTime = 0;
    }

    if (activeChatRef) {
        activeChatRef.off();
        console.log("Koneksi chat lama diputus.");
    }

    currentPartnerId = pId;
    isGroup = grp;
    currentChatId = grp ? pId : [currentUser, pId].sort().join("_");
    
    // --- OPTIMASI 1: LimitToLast(50) ---
    // Kita hanya memuat 50 pesan terakhir agar tidak LAG saat membuka chat.
    // Jika user scroll ke atas, baru kita load pesan lebih lama (opsional).
    activeChatRef = db.ref("chats/" + currentChatId).limitToLast(50);

    document.getElementById("emojiPanel").style.display = "none";
    if (window.innerWidth <= 768) document.getElementById("sidebar").classList.add("hidden");
    document.getElementById("welcome-screen").style.display = "none";
    document.getElementById("chat-header-area").style.display = "flex";
    document.getElementById("msgs").style.display = "flex";
    document.getElementById("inputArea").style.display = "block";

    document.getElementById("chatName").innerText = name;
    document.getElementById("chatAvatar").src = photo || (grp ? "https://cdn-icons-png.flaticon.com/512/615/615075.png" : "https://cdn-icons-png.flaticon.com/512/149/149071.png");

    const msgsDiv = document.getElementById("msgs");
    msgsDiv.innerHTML = "";

    // --- OPTIMASI 2: Listener Pesan ---
    activeChatRef.on("child_added", snap => {
        const m = snap.val();
        
        // Cek data valid
        if(!m) return;

        renderMessage(m, snap.key);
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
        
        // LOGIKA AUTO READ (STANDAR)
        // Hanya update seen jika: Bukan pesan saya sendiri && Belum terbaca
        // Kita cek 'm' dari snapshot agar tidak query ke DB dua kali
        if (m.from !== currentUser && !m.seen) {
            db.ref("chats/" + currentChatId + "/" + snap.key).update({ seen: true })
                .catch(e => console.log("Gagal update seen:", e));
        }
    });

    activeChatRef.on("child_changed", snap => {
        const oldMsg = document.getElementById("msg-wrap-" + snap.key);
        if(oldMsg) {
            oldMsg.remove();
            renderMessage(snap.val(), snap.key);
        }
    });

    // --- Listener Typing ---
    // Matikan listener lama agar tidak tertumpuk
    const typingRef = db.ref(`typing/${currentChatId}`);
    // Gunakan fungsi off pada referensi yang tepat
    // Kita tidak perlu 'off' disini karena watchTyping akan menghandle referensi
    
    watchTyping(currentChatId);

    // --- Update Status ---
    if(!grp) {
        updatePartnerOnlineStatus();
    } else { 
        document.getElementById("chatStatus").innerText = "Grup Chat"; 
        document.getElementById("chatStatus").style.color = "var(--text-muted)";
        isEditing = false;
        cancelReply();
        db.ref("group_members/" + pId).once("value", snap => {
            groupMembersCount[pId] = snap.numChildren();
        });
    }
}

/// --- 1. FUNGSI TOMBOL UTAMA (KLIK TOMBOL VIDEO) ---
function startJitsi(type) {
    if (!currentChatId) {
        showToast("Buka chat dulu!");
        return;
    }

    // Buat Nama Room Unik (Timestamp)
    const roomName = type === 'video' ? `Video_${Date.now()}` : `Audio_${Date.now()}`;
    
    // Kirim Pesan Chat
    pushMsg(`CALL_JITSI:${type}:${roomName}`);
    
    // Langsung Join
    joinVideoCall(roomName, type);
}

function joinVideoCall(channelName, type) {
    // Tampilkan Modal
    document.getElementById("videoCallModal").style.display = "block";

    // Bersihkan Container
    document.getElementById("jitsi-container").style.display = "block";

    const myName = document.getElementById("myName").innerText || "User";

    // Setup Jitsi Options
    const options = {
        roomName: channelName,
        width: "100%",
        height: "100%",
        parentNode: document.querySelector('#jitsi-container'),
        // --- CONFIG: LANGSUNG MASUK (NO PREJOIN) ---
        configOverwrite: {
            startWithAudioMuted: false, // Audio Nyala Langsung
            startWithVideoMuted: false, // Video Nyala Langsung
            prejoinPageEnabled: false, // <--- MATIKAN HALAMAN JOIN (INI YG PENTING)
            disableDeepLinking: true, // Mencegah loop
            startWithScreenSharing: false,
            startWithTileView: false,
        },
        interfaceConfigOverwrite: {
            SHOW_JITSI_WATERMARK: false,
            SHOW_WATERMARK_FOR_GUESTS: false,
            DEFAULT_BACKGROUND: '#000',
            // MATIKAN TOOLBAR OPSIONAL (Kalau mau super bersih)
            // TOOLBAR_BUTTONS: ['microphone', 'camera', 'closedcaptions', 'hangup'],
        },
        // --- USER INFO: Nama Kita ---
        userInfo: {
            displayName: myName
        }
    };

    // Init API
    window.jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", options);

    // Event Listeners
    window.jitsiApi.addEventListeners({
        readyToClose: function() {
            endVideoCall();
        },
        videoConferenceJoined: function() {
            console.log("Jitsi: Langsung masuk!", channelName);
        },
        videoLeft: function() {
            console.log("Seseorang keluar");
        },
        participantLeft: function() {
            console.log("Seseorang berhenti");
        }
    });
}

function endVideoCall() {
    // 1. Matikan Jitsi
    if (window.jitsiApi) {
        try {
            window.jitsiApi.dispose();
            window.jitsiApi = null;
        } catch (e) {
            console.error("Gagal dispose Jitsi", e);
        }
    }

    // 2. HENTIKAN RINGTONE (PENTING!)
    const ringtoneSound = document.getElementById("ringtoneSound");
    if (ringtoneSound) {
        ringtoneSound.pause(); // Matikan suara
        ringtoneSound.currentTime = 0; // Reset ke awal (supaya next call mulai dari awal)
    }

    // Hide Container & Modal
    document.getElementById("jitsi-container").style.display = "none";
    document.getElementById("videoCallModal").style.display = "none";
    
    showToast("Panggilan berakhir");
}
// --- 4. FUNGSI RENDER MESSAGE (Sederhanakan) ---
// Hapus kode CALL_PEER atau CALL_LINK yang ribet.
// Jika pesan ada kata "CALL_JITSI", langsung gabung Jitsi.
function renderMessage(m, key) {
    if (document.getElementById("msg-wrap-" + key)) return;

    const isMe = m.from === currentUser;
    const wrap = document.createElement("div");
    wrap.className = `msg-wrap ${isMe ? 'me' : 'you'}`;
    wrap.id = "msg-wrap-" + key;
    
    // --- VARIABEL TOUCH IPHONE ---
    let touchStartX, touchStartY, touchTimer;
    
    // 1. Right Click
    wrap.oncontextmenu = (e) => {
        e.preventDefault();
        if (typeof openContextMenu === "function") {
            openContextMenu(e, key, m);
        }
    };

    // 2. Touch Start
    wrap.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        if (touchTimer) clearTimeout(touchTimer);
        touchTimer = setTimeout(() => {
            if (typeof openContextMenu === "function") {
                openContextMenu({
                    clientX: touchStartX,
                    clientY: touchStartY,
                    preventDefault: () => {}
                }, key, m);
            }
        }, 600);
    }, { passive: false });

    // 3. Touch Move
    wrap.addEventListener('touchmove', (e) => {
        if (!touchTimer) return;
        const touch = e.touches[0];
        const moveX = Math.abs(touch.clientX - touchStartX);
        const moveY = Math.abs(touch.clientY - touchStartY);
        if (moveX > 10 || moveY > 10) {
            clearTimeout(touchTimer);
            touchTimer = null;
        }
    }, { passive: false });

    // 4. Touch End
    wrap.addEventListener('touchend', () => {
        clearTimeout(touchTimer);
        touchTimer = null;
    });
    // ----------------------------------------------

    let forwardHtml = m.forwarded ? `<div class="forward-tag" style="font-size:10px; opacity:0.6; margin-bottom:2px;"><i class="fa fa-share"></i> Diteruskan</div>` : "";
    let replyHtml = "";
    if (m.replyTo) {
        replyHtml = `
            <div class="reply-box-in-msg" onclick="scrollToMessage('${m.replyTo.id}')" style="background: rgba(0,0,0,0.1); border-left: 3px solid var(--accent); padding: 5px; margin-bottom: 5px; border-radius: 4px; cursor: pointer;">
                <b style="color:var(--accent); font-size:11px;">${m.replyTo.user === currentUser ? "Anda" : m.replyTo.user}</b>
                <div style="font-size:11px; opacity:0.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${decryptData(m.replyTo.text)}</div>
            </div>`;
    }

    let content = "";
    if (m.deleted) {
        content = `<div class="msg deleted" style="font-style:italic; opacity:0.7;">ðŸš« Pesan telah dihapus</div>`;
    } else {
        let textBody = "";
        try {
            if (m.text.startsWith("IMG:")) {
                const url = decryptData(m.text.replace("IMG:", ""));
                textBody = `<img src="${url}" onclick="window.open('${url}')" style="max-width:100%; border-radius:10px; cursor:pointer;">`;
            } 
            else if (m.text.startsWith("TYPE:VN:")) {
                const url = decryptData(m.text.replace("TYPE:VN:", ""));
                textBody = `<div class="vn-container" style="display:flex; align-items:center; gap:8px; padding:5px 0;"><audio src="${url}" controls class="vn-player" style="max-width:200px; height:30px;"></audio></div>`;
            } 
            // --- LOGIKA VIDEO CALL (PEMBARUAN: TERPISAH VIDEO & AUDIO) ---
            else if (m.text.startsWith("CALL_JITSI:")) {
                const p = m.text.split(":");
                const roomName = p[2];
                const callType = p[1]; // Mengambil tipe: 'video' atau 'audio'
                
                // Tentukan Ikon & Teks berdasarkan tipe
                let icon = "fa-video";     // Default: Kamera
                let textLabel = "Panggilan Video"; // Default: Video

                if (callType === 'audio') {
                    icon = "fa-phone-alt"; // Jika Audio: Telepon
                    textLabel = "Panggilan Suara"; // Jika Audio: Suara
                }
                
                textBody = `
                    <div class="call-msg" onclick="joinVideoCall('${roomName}', '${callType}')" style="cursor:pointer; text-align:center; background: rgba(212, 163, 115, 0.1); padding: 15px; border-radius: 15px; margin: 5px 0; color: var(--accent); border: 1px dashed var(--accent);">
                        <i class="fas ${icon}"></i><br>
                        <small>${textLabel} (Klik Gabung)</small>
                    </div>`;
            }
            else {
                textBody = `<span>${decryptData(m.text)}</span>`;
            }
        } catch (e) {
            textBody = `<span style="color:red; font-size:10px;">Gagal mendekripsi pesan</span>`;
        }

        const editedLabel = m.edited ? `<small style="opacity:0.5; font-size:9px; margin-left:5px;">(diedit)</small>` : "";

        content = `
            <div class="msg">
                ${forwardHtml}
                ${replyHtml}
                ${textBody}
                ${editedLabel}
            </div>`;
    }

    const time = new Date(m.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    let statusIcons = "";

    if (isMe && !m.deleted) {
        if (typeof isGroup !== 'undefined' && isGroup) {
            const seenByCount = m.seenBy ? Object.keys(m.seenBy).length : 0;
            const totalMembers = typeof groupMembersCount !== 'undefined' ? groupMembersCount[currentChatId] || 2 : 2; 
            if (seenByCount >= totalMembers) {
                statusIcons = `<span style="color:var(--accent); font-weight:bold;">âœ“âœ“</span>`;
            } else if (seenByCount > 1) {
                statusIcons = `âœ“âœ“`;
            } else {
                statusIcons = `âœ“`;
            }
        } else {
            statusIcons = m.seen ? `<span style="color:var(--accent); font-weight:bold;">âœ“âœ“</span>` : `âœ“`;
        }
    }
    
    const senderName = (typeof isGroup !== 'undefined' && isGroup && !isMe && !m.deleted) ? `<div style="font-size:10px; font-weight:bold; color:var(--accent); margin-bottom:2px;">${m.from}</div>` : "";

    wrap.innerHTML = `
        ${senderName}
        ${content}
        <div class="msg-meta" style="display:flex; align-items:center; gap:4px; justify-content:flex-end; font-size:10px; opacity:0.7; margin-top:2px;">
            ${time} ${statusIcons}
        </div>
    `;

    const msgsDiv = document.getElementById("msgs");
    msgsDiv.appendChild(wrap);
    msgsDiv.scrollTop = msgsDiv.scrollHeight; 

    // Update Seen Status
    if (!isMe && typeof currentChatId !== 'undefined' && currentChatId) {
        if (typeof isGroup !== 'undefined' && isGroup) {
            if (!m.seenBy || !m.seenBy[currentUser]) {
                db.ref(`chats/${currentChatId}/${key}/seenBy/${currentUser}`).set(true);
            }
        } else {
            if (!m.seen) {
                db.ref(`chats/${currentChatId}/${key}`).update({ seen: true });
            }
        }
    }
}

// --- 5. INIT PAGI (Hapus PeerJS Init) ---
// HAPUS initPeerJS(). JANGAN PANGGIL FUNGSI INIT APAPUN.
// Kita hanya perlu Jitsi.
// Fungsi Handle Delete (SUDAH DIPERBAIKI)
function handleDelete() {
    document.getElementById("msgMenu").style.display = "none"; // <--- PERBAIKAN: Tambah titik koma
    const now = Date.now();
    const isMe = selectedMsgData.from === currentUser; // <--- PERBAIKAN: Tambah titik koma
    const canDeleteEveryone = isMe && (now - selectedMsgData.time < 172800000);

    const sheet = document.getElementById("deleteSheet");
    const btnEveryone = document.getElementById("btnDeleteEveryone");

    btnEveryone.style.display = canDeleteEveryone ? "block" : "none";
    
    sheet.style.display = "flex";
}

function confirmDeleteEveryone() {
    db.ref(`chats/${currentChatId}/${selectedMsgId}`).update({
        deleted: true,
        text: encryptData("ðŸš« Pesan ini telah dihapus"),
        replyTo: null,
        forwarded: null
    });
    closeDeleteSheet();
    showToast("Dihapus untuk semua orang");
}

function confirmDeleteMe() {
    const el = document.getElementById("msg-wrap-" + selectedMsgId);
    if(el) el.remove();
    closeDeleteSheet();
    showToast("Dihapus untuk Anda");
}

function closeDeleteSheet() { document.getElementById("deleteSheet").style.display = "none"; }
/* =========================================
    SEND FUNCTIONS
    ========================================= */
async function send() {
    const textInput = document.getElementById("text");
    if (!textInput || !currentChatId) return; 
    
    const val = textInput.value.trim();

    if (typeof vnBlob !== 'undefined' && vnBlob) {
        showToast("Mengirim Voice Note...");
        const reader = new FileReader();
        reader.readAsDataURL(vnBlob);
        reader.onloadend = function() {
            const encryptedVN = "TYPE:VN:" + encryptData(reader.result);
            const msgObj = {
                from: currentUser,
                text: encryptedVN,
                time: Date.now(),
                seenBy: { [currentUser]: true } 
            };
            
            if (typeof replyData !== 'undefined' && replyData) msgObj.replyTo = replyData;
            
            db.ref("chats/" + currentChatId).push(msgObj);
            updateSummary("ðŸŽµ Voice Note");
            
            vnBlob = null;
            textInput.value = "";
            textInput.readOnly = false;
            cancelReply();
        };
        return;
    }

    if (typeof isEditing !== 'undefined' && isEditing) {
        if (!val) return;
        db.ref(`chats/${currentChatId}/${selectedMsgId}`).update({
            text: encryptData(val),
            edited: true
        }).then(() => {
            isEditing = false;
            textInput.value = "";
            showToast("Pesan diperbarui");
        });
    } 
    
    else {
        if (!val) return;
        const msgObj = {
            from: currentUser,
            text: encryptData(val),
            time: Date.now(),
            seenBy: { [currentUser]: true } 
        };
        
        msgObj.seen = false;
        
        if (typeof replyData !== 'undefined' && replyData) {
            msgObj.replyTo = replyData;
        }
        
        db.ref("chats/" + currentChatId).push(msgObj).then(() => {
            textInput.value = "";
            updateSummary(val);
            cancelReply(); 
        });
    }

    db.ref(`typing/${currentChatId}/${currentUser}`).remove();
}
// Fungsi untuk Membuka Menu Konteks
function openContextMenu(e, key, data) {
    if(data.deleted) return;
    selectedMsgId = key;
    selectedMsgData = data;
    
    const menu = document.getElementById("msgMenu");
    menu.style.display = "block";
    
    let top = e.clientY;
    let left = e.clientX;
    if (top > window.innerHeight - 200) top -= 200;
    if (left > window.innerWidth - 180) left -= 180;

    menu.style.top = top + "px";
    menu.style.left = left + "px";

    const now = Date.now();
    const canEdit = (now - data.time < 3600000) && (data.from === currentUser);
    document.getElementById("menu-edit").style.display = canEdit ? "flex" : "none";

    setTimeout(() => {
        document.onclick = () => {
            menu.style.display = "none";
            document.onclick = null;
        };
    }, 100);
}
function handleForward() {
    document.getElementById("msgMenu").style.display = "none";

    const targetId = prompt("Masukkan User ID atau Group ID tujuan:");
    
    if (!targetId || targetId.trim() === "") return;

    executeForward(targetId.trim());
}

function executeForward(targetId) {
    const isGrp = targetId.startsWith("GROUP_");
    const targetChatId = isGrp ? targetId : [currentUser, targetId].sort().join("_");

    const forwardData = {
        from: currentUser,
        text: selectedMsgData.text, 
        time: Date.now(),
        seen: false,
        forwarded: true
    };

    db.ref("chats/" + targetChatId).push(forwardData)
        .then(() => {
            showToast("Pesan berhasil diteruskan ke " + targetId);
            
            const summary = { lastMsg: "âž¡ï¸ Pesan diteruskan", time: Date.now() };
            db.ref(`user_chats/${currentUser}/${targetId}`).update(summary);
            if(!isGrp) db.ref(`user_chats/${targetId}/${currentUser}`).update(summary);
        })
        .catch((err) => {
            console.error(err);
            showToast("Gagal meneruskan: ID tidak valid");
        });
}

function closeForwardModal() { document.getElementById("forwardModal").style.display = "none"; }

function handleCopy() {
    const txt = decryptData(selectedMsgData.text);
    navigator.clipboard.writeText(txt);
    showToast("Pesan disalin!");
}

function handleReply() {
    document.getElementById("msgMenu").style.display = "none";
    
    if (!selectedMsgData) return;

    replyData = {
        id: selectedMsgId, 
        user: selectedMsgData.from,
        text: selectedMsgData.text 
    };

    document.getElementById("reply-preview").style.display = "block";
    document.getElementById("reply-user").innerText = (replyData.user === currentUser) ? "Anda" : replyData.user;
    document.getElementById("reply-text").innerText = decryptData(replyData.text);
    
    document.getElementById("text").focus();
}

function scrollToMessage(msgId) {
    const targetEl = document.getElementById("msg-wrap-" + msgId);
    if (targetEl) {
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        targetEl.style.transition = "background 0.5s";
        targetEl.style.backgroundColor = "rgba(212, 163, 115, 0.4)";
        
        setTimeout(() => {
            targetEl.style.backgroundColor = "transparent";
        }, 1500);
    } else {
        showToast("Pesan asli sudah terlalu lama atau dihapus");
    }
}
function cancelReply() {
    replyData = null;
    document.getElementById("reply-preview").style.display = "none";

}
function handleEdit() {
    isEditing = true;
    document.getElementById("text").value = decryptData(selectedMsgData.text);
    document.getElementById("text").focus();
    showToast("Mode Edit Aktif");

}

async function sendImage(input) {
    if(!input.files[0]) return;
    showToast("Mengompres Gambar...");
    const reader = new FileReader();
    reader.readAsDataURL(input.files[0]);
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 800;
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            pushMsg("IMG:" + encryptData(canvas.toDataURL('image/jpeg', 0.7)));
            updateSummary("ðŸ“· Gambar");
        };
    };
}

/* =========================================
    HELPERS
    ========================================= */
function encryptData(data) { return CryptoJS.AES.encrypt(data, SECRET_KEY).toString(); }
function decryptData(cipher) { 
    try { 
        const bytes = CryptoJS.AES.decrypt(cipher, SECRET_KEY);
        return bytes.toString(CryptoJS.enc.Utf8) || "[Pesan Terenkripsi]";
    } catch(e) { return "[Pesan Terenkripsi]"; }
}

function pushMsg(text) {
    db.ref("chats/" + currentChatId).push({ from: currentUser, text: text, time: Date.now(), seen: false });
}

function updateSummary(msg) {
    const s = { lastMsg: msg.length > 30 ? msg.substring(0,30) + "..." : msg, time: Date.now() };
    if (isGroup) {
        db.ref("group_members/" + currentPartnerId).once("value", snap => {
            snap.forEach(m => db.ref(`user_chats/${m.key}/${currentPartnerId}`).update(s));
        });
    } else {
        db.ref(`user_chats/${currentUser}/${currentPartnerId}`).update(s);
        db.ref(`user_chats/${currentPartnerId}/${currentUser}`).update(s);
    }
}

function setupEmoji() {
    const panel = document.getElementById('emojiPanel');
    const emojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜','ðŸ¥°','ðŸ˜˜','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ§','ðŸ˜Ž','ðŸ¥³','ðŸ˜','ðŸ˜’','ðŸ˜”','ðŸ¥º','ðŸ˜¢','ðŸ˜­','ðŸ˜¤','ðŸ˜ ','ðŸ˜¡','ðŸ¤¯','ðŸ˜³','ðŸ˜´','ðŸ˜µ','ðŸ¤','ðŸ¤¢','ðŸ˜ˆ','ðŸ’€','ðŸ‘»','ðŸ‘½','ðŸ¤–','ðŸ™Œ','ðŸ‘','ðŸ‘‹','ðŸ‘','ðŸ‘Ž','ðŸ‘Š','âœŒï¸','ðŸ‘Œ','ðŸ™','â¤ï¸','ðŸ”¥','âœ¨','ðŸŒŸ'];
    panel.innerHTML = emojis.map(e => `<div class="emoji-item">${e}</div>`).join('');
    document.getElementById('emojiButton').onclick = (e) => { e.stopPropagation(); panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid'; };
    panel.querySelectorAll('.emoji-item').forEach(el => el.onclick = () => { document.getElementById("text").value += el.innerText; });
    document.addEventListener('click', () => panel.style.display = 'none');
}

function showToast(m) {
    const t = document.getElementById("toast");
    t.innerText = m; t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
}

function closeChat() { document.getElementById("sidebar").classList.remove("hidden"); }
function goToProfile() { window.location.href = isGroup ? `group-profile.html?id=${currentPartnerId}` : `user-profile.html?id=${currentPartnerId}`; }
function goToTargetProfile(id, grp) { window.location.href = grp ? `group-profile.html?id=${id}` : `user-profile.html?id=${id}`; }

function logout() { if(confirm("Keluar?")) { localStorage.clear(); window.location.href="index.html"; } }

window.onload = initApp;
document.getElementById("text").onkeydown = e => { if(e.key === "Enter") send(); };
function setupGlobalNotificationListener() {
    // --- SAFETY CHECK 1: Firebase Terload? ---
    if (typeof firebase === 'undefined') {
        console.error(">>> ERROR: Firebase TIDAK TERLOAD!");
        console.error(">>> PERIKSA SCRIPT TAG <script firebase...> DI <HEAD>");
        return;
    }

    // --- SAFETY CHECK 2: Variabel DB Ada? ---
    if (typeof db === 'undefined') {
        console.error(">>> ERROR: 'db' TIDAK DIDEFINISI!");
        console.error(">>> PERIKSA 'const db = firebase.database();' DI PUNTING SCRIPT ANDA.");
        return;
    }

    // --- SAFETY CHECK 3: Variabel Listener Ada? ---
    if (typeof globalNotifListener === 'undefined') {
        console.error(">>> ERROR: 'globalNotifListener' TIDAK DIDEFINISI!");
        console.error(">>> PERIKSA 'let globalNotifListener = null;' DI PUNTING SCRIPT ANDA.");
        return;
    }

    logToScreen(">>> SETUP BERHASIL. VARIABEL ADA.");

    // --- KODE UTAMA ---
    if (globalNotifListener) {
        db.ref(`user_chats/${currentUser}`).off('value', globalNotifListener);
    }

    globalNotifListener = db.ref(`user_chats/${currentUser}`).on("value", (snap) => {
        // ... lanjut logika listener di sini ...
        snap.forEach((child) => {
            const chatId = child.key.startsWith("GROUP_") 
                ? child.key 
                : [currentUser, child.key].sort().join("_");

            // ... lanjut ...
        });
    });
}// --- FUNGSI DEBUG LOG (FIX ERROR REFERENCE) ---
function logToScreen(txt) {
    // Ambil elemen HTML yang tadi kita buat
    const logEl = document.getElementById("debug-text");
    const container = document.getElementById("debug-log");
    
    if (logEl && container) {
        container.style.display = "block";
        
        // Tulis log baru
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] ${txt}</div>`;
        
        // Auto scroll ke bawah
        logEl.scrollTop = logEl.scrollHeight;

        // Hapus log lama biar layar tidak penuh
        const divs = logEl.getElementsByTagName("div");
        if (divs.length > 5) {
            logEl.removeChild(divs[0]);
        }
    }
}
// --- FUNGSI TAMPILKAN POP-UP BROWSER ---
function showSystemNotification(sender, message, partnerId) {
    console.log(`[DEBUG] Cek Izin: ${Notification.permission}`);

    if (Notification.permission === "granted") {
        let shortMsg = message;
        if (shortMsg.length > 50) shortMsg = shortMsg.substring(0, 50) + "...";

        const options = {
            body: shortMsg,
            icon: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
            badge: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
            vibrate: [200, 100, 200],
            tag: partnerId
        };

        try {
            const notification = new Notification(sender, options);
            notification.onclick = function() {
                window.focus();
                openChat(partnerId, '', sender, partnerId.startsWith("GROUP_"));
                this.close();
            };
        } catch (e) {
            console.error("[ERROR] Notif Browser Error:", e);
        }

    } else if (Notification.permission !== "denied") {
        Notification.requestPermission();
    } else {
        console.error("[DEBUG] Izin Notif DITOLAK (Blocked).");
    }
}

function pinChat(targetId) {
    const pinRef = db.ref(`user_settings/${currentUser}/pinned_chats/${targetId}`);
    
    pinRef.once('value', (snapshot) => {
        if (snapshot.exists()) {
            pinRef.remove(); // Jika sudah di-pin, maka lepas (unpin)
            showToast("Sematkan dilepas");
            
            // Refresh list agar style 'pinned' hilang
            const list = document.getElementById("users");
            if(list) list.innerHTML = "";
            loadContacts(); 
            
        } else {
            pinRef.set(true); // Jika belum, maka sematkan (pin)
            showToast("Chat disematkan ke atas");
            
            // Refresh list agar style 'pinned' muncul
            const list = document.getElementById("users");
            if(list) list.innerHTML = "";
            loadContacts();
        }
        closeContextMenu();
    });
}

function deleteChat(targetId) {
    if (confirm("Hapus percakapan ini dari daftar Anda?")) {
        // 1. Hapus dari daftar chat aktif
        db.ref(`user_chats/${currentUser}/${targetId}`).remove();
        // 2. Hapus status pin jika ada
        db.ref(`user_settings/${currentUser}/pinned_chats/${targetId}`).remove();
        
        showToast("Kontak dihapus dari daftar");
        closeContextMenu();
        
        // 3. Refresh list agar chat hilang dari sidebar
        const list = document.getElementById("users");
        if(list) list.innerHTML = "";
        loadContacts();
        
        // Opsional: Jika sedang membuka chat tersebut, tutup
        if (currentChatId === targetId) {
            document.getElementById("chat-header-area").style.display = "none";
            document.getElementById("msgs").style.display = "none";
            document.getElementById("inputArea").style.display = "none";
            document.getElementById("welcome-screen").style.display = "flex";
            // Tampilkan sidebar kembali jika di mobile
            document.getElementById("sidebar").classList.remove("hidden");
        }
    }
}

function setupHoldListener(element, targetId) {
    let internalHoldTimer;
    let touchStartX, touchStartY; 

    element.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (typeof showChatMenu === "function") {
            showChatMenu(e.clientX, e.clientY, targetId);
        }
    });

    element.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;

        if (internalHoldTimer) clearTimeout(internalHoldTimer);

        internalHoldTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50);
            if (typeof showChatMenu === "function") {
                showChatMenu(touchStartX, touchStartY, targetId);
            }
        }, 600); 
    }, { passive: true });

    element.addEventListener('touchmove', (e) => {
        if (!internalHoldTimer) return;
        
        const touch = e.touches[0];
        const moveX = Math.abs(touch.clientX - touchStartX);
        const moveY = Math.abs(touch.clientY - touchStartY);

        if (moveX > 10 || moveY > 10) {
            clearTimeout(internalHoldTimer);
            internalHoldTimer = null;
        }
    }, { passive: true });

    element.addEventListener('touchend', () => {
        clearTimeout(internalHoldTimer);
        internalHoldTimer = null;
    });

    element.addEventListener('touchcancel', () => {
        clearTimeout(internalHoldTimer);
        internalHoldTimer = null;
    });
}

function showChatMenu(x, y, targetId) {
    let menu = document.getElementById('chat-context-menu');
    
    if (!menu) {
        menu = document.createElement('div');
        menu.id = 'chat-context-menu';
        menu.style.position = 'fixed';
        menu.style.zIndex = '10000';
        menu.style.background = '#222';
        menu.style.border = '1px solid #444';
        menu.style.borderRadius = '8px';
        menu.style.padding = '5px 0';
        menu.style.minWidth = '150px'; // Diperlebar sedikit agar teks muat
        menu.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
        menu.style.color = 'white';
        document.body.appendChild(menu);
    }

    // --- LOGIKA CEK STATUS PIN BARU ---
    db.ref(`user_settings/${currentUser}/pinned_chats/${targetId}`).once('value', (snapshot) => {
        const isPinned = snapshot.exists();
        
        // Tentukan Teks dan Ikon berdasarkan status
        const pinText = isPinned ? "Lepas Sematan" : "Sematkan";
        const pinIcon = isPinned ? "fa-thumbtack" : "fa-thumbtack"; // Bisa diganti fa-thumbtack yang lain jika mau
        const pinColor = isPinned ? "#ff5e5e" : "white"; // Merah jika mau dilepas, Putih jika mau pasang

        // Isi Menu
        menu.innerHTML = `
            <div onclick="pinChat('${targetId}')" style="padding: 10px 15px; cursor: pointer; color: ${pinColor};">
                <i class="fas ${pinIcon}" style="margin-right:10px;"></i> ${pinText}
            </div>
            <div onclick="deleteChat('${targetId}')" style="padding: 10px 15px; cursor: pointer; color: #ff5e5e;">
                <i class="fas fa-trash" style="margin-right:10px;"></i> Hapus Chat
            </div>
        `;

        // Atur Posisi Menu
        const menuWidth = 160;
        const menuHeight = 100;
        let finalX = x;
        let finalY = y;

        if (x + menuWidth > window.innerWidth) finalX = window.innerWidth - menuWidth - 10;
        if (y + menuHeight > window.innerHeight) finalY = window.innerHeight - menuHeight - 10;

        menu.style.left = finalX + 'px';
        menu.style.top = finalY + 'px';
        menu.style.display = 'block';

        // Klik di mana saja untuk tutup menu
        const closeMenu = () => {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 10);
    });
}

function openMenu(x, y) {
    const menu = document.getElementById('contextMenu');
    const overlay = document.getElementById('menuOverlay');
    
    if (!menu) return;

    menu.style.display = 'block';
    overlay.style.display = 'block';

    let posX = x;
    let posY = y;
    
    if (x + 180 > window.innerWidth) posX = x - 180;
    else posX = x + 10; 

    if (y + 100 > window.innerHeight) posY = y - 100;

    menu.style.left = posX + "px";
    menu.style.top = posY + "px";
}
function closeContextMenu() {
    if (contextMenu) contextMenu.style.display = 'none';
    if (menuOverlay) menuOverlay.style.display = 'none';
}

if (contextMenu) {
    contextMenu.onclick = (e) => e.stopPropagation();
}

function startTimer() {
    let sec = 0, min = 0;
    const timerDisplay = document.getElementById('record-timer');
    if (!timerDisplay) return;
    if (recordInterval) clearInterval(recordInterval);
    recordInterval = setInterval(() => {
        sec++;
        if (sec == 60) { min++; sec = 0; }
        timerDisplay.innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }, 1000);
}

// --- 1. FUNGSI MULAI REKAM (FIX VISIBILITY) ---
async function handleStart(e) {
    if (e.cancelable) e.preventDefault();

    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    isCancelled = false;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop());

            if (!isCancelled && audioChunks.length > 0) {
                const vnBlob = new Blob(audioChunks, { type: 'audio/webm' });
                showToast("Mengirim Voice Note...");

                const formData = new FormData();
                formData.append('file', vnBlob);
                formData.append('upload_preset', 'hanung'); 
                formData.append('resource_type', 'video'); 

                try {
                    const response = await fetch('https://api.cloudinary.com/v1_1/dwu8dbfjp/video/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.secure_url) {
                        const encryptedURL = encryptData(data.secure_url);
                        const finalMessage = "TYPE:VN:" + encryptedURL;
                        db.ref("chats/" + currentChatId).push({
                            from: currentUser,
                            text: finalMessage,
                            time: Date.now()
                        });
                        showToast("VN Terkirim!");
                    } else {
                        showToast("Gagal upload VN.");
                    }
                } catch (error) {
                    console.error(error);
                    showToast("Error koneksi server.");
                }
            }
            // Panggil fungsi reset tampilan di sini
            toggleRecordingUI(false);
        };

        mediaRecorder.start();
        
        // PANGGIL FUNGSI TAMPILAN (TRUE = Merekam)
        toggleRecordingUI(true);
        startTimer();

    } catch (err) {
        console.error(err);
        alert("Akses mic ditolak.");
        toggleRecordingUI(false); // Pastikan balik normal jika error
    }
}
function toggleRecordingUI(isRecording) {
    const normalInput = document.getElementById("normal-input");
    const recordingUI = document.getElementById("recording-ui");
    const sendButton = document.getElementById("sendButton");
    const micButton = document.getElementById("micButton");

    // --- DETEKSI PERANGKAT ---
    const isMobile = window.innerWidth <= 768;

    if (isRecording) {
        // --- SAAT MEREKAM ---
        
        if (isMobile) {
            // KHUSUS HP: Matikan display-nya agar ruang benar-benar kosong (Fix Crop)
            if(normalInput) normalInput.style.display = 'none';
            if(sendButton) sendButton.style.display = 'none';
        } else {
            // KHUSUS LAPTOP: Pakai Opacity (Transparan) agar transisi smooth
            if(normalInput) {
                normalInput.style.opacity = '0'; 
                normalInput.style.pointerEvents = 'none';
            }
            // Di laptop tombol send juga disembunyikan saat rekam
            if(sendButton) sendButton.style.display = 'none';
        }

        if(recordingUI) recordingUI.style.display = 'flex';
        if(micButton) micButton.style.color = '#ff5e5e';
        
    } else {
        // --- SAAT SELESAI (RESET) ---
        clearInterval(recordInterval);
        const timerDisplay = document.getElementById('record-timer');
        if(timerDisplay) timerDisplay.innerText = "00:00";

        if(recordingUI) recordingUI.style.display = 'none';
        
        if (isMobile) {
            // KHUSUS HP: Kembalikan display flex
            if(normalInput) normalInput.style.display = 'flex';
            if(sendButton) sendButton.style.display = 'flex';
        } else {
            // KHUSUS LAPTOP: Kembalikan opacity
            if(normalInput) {
                normalInput.style.opacity = '1'; 
                normalInput.style.pointerEvents = 'auto';
            }
            // Kembalikan tombol send di laptop
            if(sendButton) sendButton.style.display = 'block';
        }

        if(micButton) micButton.style.color = '';
    }
}

// --- 2. FUNGSI DETEKSI GESER & BERHENTI ---
function handleMove(e) {
    if (!mediaRecorder || mediaRecorder.state !== "recording") return;
    let currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    let diffX = startX - currentX;
    const instruction = document.getElementById('slide-instruction');
    
    if (diffX > 60) {
        isCancelled = true;
        if(instruction) {
            // TEKS DIPERPENDEK: "Batalkan"
            instruction.innerHTML = "<i class='fas fa-trash'></i> Batalkan"; 
            instruction.style.color = "#ff5e5e";
        }
    } else {
        isCancelled = false;
        if(instruction) {
            // TEKS DIPERPENDEK: "Geser Batal"
            instruction.innerHTML = "<i class='fas fa-chevron-left'></i> Geser Batal"; 
            instruction.style.color = "#888";
        }
    }
}

function handleStop() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        // Tampilan di-reset otomatis oleh mediaRecorder.onstop
    } else {
        toggleRecordingUI(false); // Paksa reset jika error
    }
}

// --- 3. EVENT LISTENERS (Pastikan ada) ---
if(micButton) {
    micButton.addEventListener('mousedown', handleStart);
    micButton.addEventListener('touchstart', handleStart, {passive: false});
    micButton.addEventListener('touchmove', handleMove, {passive: false});
    micButton.addEventListener('touchend', handleStop);
}

window.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state === "recording") handleStop();
});
// --- 4. FUNGSI RESET TAMPILAN (BARU) ---
function resetInputUI() {
    clearInterval(recordInterval);
    
    // Reset Timer
    const timerDisplay = document.getElementById('record-timer');
    if(timerDisplay) timerDisplay.innerText = "00:00";
    
    // Kembalikan Tampilan Awal
    if(recordingUI) recordingUI.style.display = 'none';
    if(normalInput) normalInput.style.display = 'flex';
    if(sendButton) sendButton.style.display = 'block';
    if(micButton) micButton.style.color = '';
}

// --- 5. PASANG EVENT LISTENERS ---
if(micButton) {
    // Mouse (Desktop)
    micButton.addEventListener('mousedown', handleStart);
    
    // Touch (HP)
    micButton.addEventListener('touchstart', handleStart, {passive: false});
    micButton.addEventListener('touchmove', handleMove, {passive: false});
    micButton.addEventListener('touchend', handleStop);
}

// Listener global untuk mouse agar bisa deteksi lepas tombol di luar area mic
window.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state === "recording") handleStop();
});
function handleMove(e) {
    if (!mediaRecorder || mediaRecorder.state !== "recording") return;
    let currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    let diffX = startX - currentX;

    const instruction = document.getElementById('slide-instruction');
    if (diffX > 60) {
        isCancelled = true;
        if(instruction) {
            instruction.innerHTML = "<i class='fas fa-trash'></i> Lepas untuk batal";
            instruction.style.color = "#ff5e5e";
        }
    } else {
        isCancelled = false;
        if(instruction) {
            instruction.innerHTML = "<i class='fas fa-chevron-left'></i> Geser ke kiri untuk batal";
            instruction.style.color = "#888";
        }
    }
}


</script>
</body>

</html>





